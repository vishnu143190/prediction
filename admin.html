<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Spin & Win</title>
<link rel="icon" href="logo.png">
<style>
  body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#0b1220;color:#eef2ff;margin:0;padding:18px;}
  .wrap{max-width:980px;margin:12px auto;padding:18px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px}
  h1{margin:0 0 8px;font-size:20px}
  label{display:block;margin-top:12px;font-size:13px;color:#9aa4b2}
  input[type=text], textarea, select {width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#071122;color:#fff}
  textarea{min-height:90px;resize:vertical}
  .row{display:flex;gap:8px;margin-top:12px}
  button{background:#7c3aed;border:0;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .muted{color:#9aa4b2;font-size:13px}
  .small{font-size:13px}
  .success{color:#22c55e}
  .error{color:#fb7185}
  .box{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-top:12px}
  .note{font-size:13px;color:#9aa4b2;margin-top:8px}
  .flex {display:flex;gap:8px;align-items:center}
  .spacer{flex:1}
  .danger{background:#ef4444}
  pre{background:#061022;padding:10px;border-radius:8px;overflow:auto;color:#d1d5db}
</style>
</head>
<body>
  <div class="wrap" role="main">
    <h1>Admin — Spin & Win</h1>
    <div class="muted">Edit prizes and settings. You can <strong>download</strong> the updated index.html or save directly to GitHub (requires PAT).</div>

    <!-- simple password gate -->
    <label>Admin password (set in file)</label>
    <input id="adminPass" type="text" placeholder="Enter admin password to unlock (default: admin123)">
    <div class="note">This is a lightweight client-side gate. For real security use server-side admin with proper auth.</div>

    <div id="editor" style="display:none">
      <label>Prize list (one per line)</label>
      <textarea id="prizesInput" placeholder="10&#10;20&#10;30&#10;40&#10;Oops&#10;Try Again"></textarea>

      <label>Default theme</label>
      <select id="themeSelect"><option value="dark">Dark</option><option value="light">Light</option></select>

      <label><input id="limitToggle" type="checkbox" /> Enable one-spin-per-day limit</label>

      <label>Optional message shown under prizes</label>
      <input id="messageInput" type="text" placeholder="Good luck!">

      <div class="row">
        <button id="generateBtn">Download index.html</button>
        <button class="ghost" id="previewBtn">Preview Generated HTML</button>
        <div class="spacer"></div>
        <button id="clearLS" class="ghost">Clear Site localStorage</button>
      </div>

      <div class="box">
        <div class="small">Save directly to GitHub (optional)</div>
        <label>GitHub owner (username)</label><input id="ghOwner" type="text" placeholder="vishnu143190">
        <label>Repository name</label><input id="ghRepo" type="text" placeholder="prediction">
        <label>Branch</label><input id="ghBranch" type="text" placeholder="main">
        <label>Commit message</label><input id="ghMsg" type="text" placeholder="Update index.html (prizes)">

        <label>Personal Access Token (PAT)</label><input id="ghToken" type="text" placeholder="ghp_xxx... (keep secret)">
        <div class="row" style="margin-top:8px">
          <button id="saveToGitBtn">Save to GitHub</button>
          <button id="previewCommit" class="ghost">Show Prepared Commit Payload</button>
          <div class="spacer"></div>
          <button id="logout" class="ghost">Lock (logout)</button>
        </div>

        <div id="ghStatus" class="note" style="margin-top:8px"></div>
      </div>

      <div id="previewBox" class="box" style="display:none;margin-top:12px">
        <div class="small">Preview (generated index.html)</div>
        <pre id="previewArea"></pre>
        <div style="margin-top:8px" class="note">If it looks good, click <strong>Download index.html</strong> and replace repository file or use Save to GitHub.</div>
      </div>
    </div>

    <div id="lockedNote" class="note" style="margin-top:12px">Enter the admin password and click anywhere outside the password field (or press Enter) to unlock the editor.</div>

  </div>

<script>
/* ======= Admin page logic ======== */

const DEFAULT_ADMIN_PASS = 'admin123'; // change after use: open admin.html and edit this line if you want a different password
const passInput = document.getElementById('adminPass');
const editor = document.getElementById('editor');
const lockedNote = document.getElementById('lockedNote');

function unlockIfCorrect() {
  const p = passInput.value.trim();
  if (!p) return;
  if (p === DEFAULT_ADMIN_PASS) {
    editor.style.display = 'block';
    lockedNote.style.display = 'none';
    passInput.style.display = 'none';
    // populate default values from current site (basic)
    document.getElementById('prizesInput').value = ['10','20','30','40','Oops','Try Again'].join('\\n');
    document.getElementById('ghOwner').value = 'vishnu143190';
    document.getElementById('ghRepo').value = 'prediction';
    document.getElementById('ghBranch').value = 'main';
    document.getElementById('ghMsg').value = 'Update index.html — admin changes';
  } else {
    alert('Wrong admin password.');
  }
}

// allow enter to unlock
passInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') unlockIfCorrect(); });
// clicking background attempts unlock too
document.addEventListener('click', (e)=>{ if (document.activeElement !== passInput && passInput.value.trim()) unlockIfCorrect(); }, {passive:true});

/* ===== build index.html content using a template (keeps your existing site behavior + popup etc) ===== */
function buildIndexHTML({prizes, theme='dark', limitEnabled=true, message='Good luck!'}) {
  // Ensure prizes is array
  const pArr = prizes.map(s => s.trim()).filter(Boolean);
  // Escape JS string values properly for embedding
  function escJS(s){ return s.replace(/\\\\/g,'\\\\\\\\').replace(/`/g,'\\\\`').replace(/\\$/g,'\\$'); }
  const prizesJsArray = '`' + pArr.map(escJS).join('`,`') + '`';
  // Use same full-featured index HTML as your site (a condensed version). For brevity we include the version that was previously built but updated with dynamic prizes.
  const generated = `<!doctype html>
<html lang="en">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Spin & Win</title><link rel="icon" href="logo.png"><style>/* minimal styles - keep same as before (abbreviated) */ body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:${ theme === 'dark' ? 'linear-gradient(180deg,#06111b 0%, #071428 100%)' : 'linear-gradient(180deg,#fff9f0 0%, #ffeedd 100%)'}; color: ${ theme === 'dark' ? '#eef2ff' : '#000'} } .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:86px;height:86px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#7c3aed;color:#fff;font-weight:800}</style></head>
<body>
  <div style="max-width:980px;margin:20px auto;padding:18px">
    <div style="text-align:center"><img src="logo.png" alt="logo" style="height:80px"></div>
    <h1 style="text-align:center">Spin & Win Lottery</h1>
    <div style="width:320px;height:320px;margin:20px auto;position:relative">
      <div style="position:absolute;left:50%;top:-20px;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:30px solid #ffd700"></div>
      <div id="wheel" style="width:320px;height:320px;border-radius:50%;background:conic-gradient(#a855f7 0 60deg,#fb923c 60deg 120deg,#38bdf8 120deg 180deg,#22c55e 180deg 240deg,#f97316 240deg 300deg,#ec4899 300deg 360deg);transition:transform 4s cubic-bezier(.12,.8,.22,1)"></div>
      <div class="center">SPIN</div>
    </div>
    <div style="text-align:center"><button id="spinBtn" style="padding:12px 20px;border-radius:999px;background:#7c3aed;color:#fff;border:0;font-weight:800">SPIN NOW</button></div>
    <div id="result" style="text-align:center;margin-top:12px;font-weight:700"></div>
    <div style="margin-top:16px;color:#9aa4b2">Message: ${message}</div>
  </div>

<script>
const prizes = [${pArr.map(s=>'\`'+s.replace(/\\\\/g,'\\\\\\\\').replace(/\\`/g,'\\\\`')+'\\`').join(', ')}];
const sliceAngle = 360 / prizes.length;
const wheel = document.getElementById('wheel');
const spinBtn = document.getElementById('spinBtn');
const result = document.getElementById('result');
let rotation = 0;

function canSpinLocal(){ ${ limitEnabled ? 'const last=localStorage.getItem(\\'prediction_last_spin_ts\\'); if(!last) return true; const diff=Date.now()-Number(last); return diff>=24*60*60*1000;' : 'return true;' } }

spinBtn.addEventListener('click', () => {
  if(!canSpinLocal()){ result.textContent = 'You can spin once per day.'; return; }
  const idx = Math.floor(Math.random()*prizes.length);
  const extra = 4 + Math.floor(Math.random()*4);
  const angle = 360*extra + (360 - (idx*sliceAngle) - sliceAngle/2);
  rotation += angle;
  wheel.style.transform = 'rotate('+rotation+'deg)';
  setTimeout(()=>{
    const normalized = (360 - (rotation % 360)) % 360;
    const landed = Math.floor(normalized / sliceAngle) % prizes.length;
    const prize = prizes[landed];
    result.textContent = 'Result: ' + prize;
    ${ limitEnabled ? "localStorage.setItem('prediction_last_spin_ts', String(Date.now()));" : '' }
    // show alert popup
    if(prize === 'Oops' || prize === 'Try Again'){
      alert(prize);
    } else {
      alert('Congratulations! You won: ' + prize);
    }
  }, 4100);
});
</script>
</body>
</html>`;
  return generated;
}

/* ===== UI actions ===== */
const generateBtn = document.getElementById('generateBtn');
const previewBtn = document.getElementById('previewBtn');
const previewBox = document.getElementById('previewBox');
const previewArea = document.getElementById('previewArea');
const prizesInput = document.getElementById('prizesInput');
const themeSelect = document.getElementById('themeSelect');
const limitToggle = document.getElementById('limitToggle');
const messageInput = document.getElementById('messageInput');
const clearLS = document.getElementById('clearLS');

generateBtn.addEventListener('click', ()=> {
  const prizes = parsePrizes();
  const html = buildIndexHTML({prizes, theme: themeSelect.value, limitEnabled: limitToggle.checked, message: messageInput.value || ''});
  downloadFile('index.html', html);
});

previewBtn.addEventListener('click', ()=> {
  const prizes = parsePrizes();
  const html = buildIndexHTML({prizes, theme: themeSelect.value, limitEnabled: limitToggle.checked, message: messageInput.value || ''});
  previewArea.textContent = html;
  previewBox.style.display = 'block';
  previewBox.scrollIntoView({behavior:'smooth'});
});

function parsePrizes(){
  return prizesInput.value.split('\\n').map(s => s.trim()).filter(Boolean);
}

function downloadFile(filename, content) {
  const blob = new Blob([content], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=> URL.revokeObjectURL(url),1500);
}

/* ======= GitHub push (optional) ======= */
const ghOwner = document.getElementById('ghOwner');
const ghRepo = document.getElementById('ghRepo');
const ghBranch = document.getElementById('ghBranch');
const ghMsg = document.getElementById('ghMsg');
const ghToken = document.getElementById('ghToken');
const saveToGitBtn = document.getElementById('saveToGitBtn');
const ghStatus = document.getElementById('ghStatus');
const previewCommit = document.getElementById('previewCommit');

previewCommit.addEventListener('click', async ()=>{
  const prizes = parsePrizes();
  const html = buildIndexHTML({prizes, theme: themeSelect.value, limitEnabled: limitToggle.checked, message: messageInput.value || ''});
  const contentB64 = btoa(unescape(encodeURIComponent(html)));
  const payload = {
    message: ghMsg.value || 'Update index.html via admin',
    content: contentB64,
    branch: ghBranch.value || 'main'
  };
  previewArea.textContent = JSON.stringify(payload, null, 2);
  previewBox.style.display = 'block';
});

saveToGitBtn.addEventListener('click', async ()=>{
  ghStatus.textContent = 'Preparing commit...';
  const owner = ghOwner.value.trim();
  const repo = ghRepo.value.trim();
  const branch = ghBranch.value.trim() || 'main';
  const token = ghToken.value.trim();
  if(!owner || !repo || !token){ ghStatus.innerHTML = '<span class="error">Owner, repo and PAT are required to commit.</span>'; return; }

  const prizes = parsePrizes();
  const html = buildIndexHTML({prizes, theme: themeSelect.value, limitEnabled: limitToggle.checked, message: messageInput.value || ''});
  const contentB64 = btoa(unescape(encodeURIComponent(html)));

  try {
    // first get the current file SHA (if exists) to do an update rather than create; if 404, we create.
    ghStatus.textContent = 'Checking existing file...';
    const fileUrl = `https://api.github.com/repos/${owner}/${repo}/contents/index.html?ref=${branch}`;
    let sha = null;
    let res = await fetch(fileUrl, {
      headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json' }
    });
    if (res.status === 200) {
      const j = await res.json();
      sha = j.sha;
    } else if (res.status === 404) {
      sha = null;
    } else {
      const text = await res.text();
      throw new Error('Failed to read file: ' + res.status + ' ' + text);
    }

    ghStatus.textContent = 'Uploading file to GitHub...';
    const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/index.html`;
    const body = {
      message: ghMsg.value || 'Update index.html via admin',
      content: contentB64,
      branch: branch
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(putUrl, {
      method: 'PUT',
      headers: { Authorization: 'token ' + token, Accept: 'application/vnd.github.v3+json', 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    const putJson = await putRes.json();
    if (putRes.ok) {
      ghStatus.innerHTML = '<span class="success">Success! index.html updated. It may take a minute to publish.</span>';
    } else {
      ghStatus.innerHTML = '<span class="error">GitHub API error: ' + (putJson && putJson.message ? putJson.message : putRes.status) + '</span>';
      console.error('GitHub API error', putJson);
    }
  } catch (err) {
    ghStatus.innerHTML = '<span class="error">Error: ' + (err.message || err) + '</span>';
    console.error(err);
  }
});

/* ===== misc ===== */
clearLS.addEventListener('click', ()=> { if(confirm('Clear the site localStorage for this browser?')) { localStorage.removeItem('prediction_last_spin_ts'); alert('Cleared'); updateLockUI(); } });

document.getElementById('logout').addEventListener('click', ()=> { location.reload(); });

function updateLockUI(){ /* placeholder if needed */ }

</script>
</body>
</html>
